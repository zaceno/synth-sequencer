!function(){"use strict";function e(e){if(e||window){var n=document.createElement("style");return n.setAttribute("media","screen"),n.innerHTML=e,document.head.appendChild(n),e}}function n(e,n){var t,o=arguments,r=[];for(a=arguments.length;a-- >2;)i.push(o[a]);for(;i.length;)if(Array.isArray(t=i.pop()))for(a=t.length;a--;)i.push(t[a]);else null!=t&&!0!==t&&!1!==t&&r.push("number"==typeof t?t+="":t);return"string"==typeof e?{type:e,props:n||{},children:r}:e(n||{},r)}function t(e,n){var o,r="",a=typeof e;if(e&&"string"===a||"number"===a)return e;if(n=n||" ",Array.isArray(e)&&e.length)for(var i=0,l=e.length;i<l;i++)(o=t(e[i],n))&&(r+=(r&&n)+o);else for(var i in e)e.hasOwnProperty(i)&&(o=e[i])&&(r+=(r&&n)+i+("object"==typeof o?t(o,n+i):""));return r}function o(e,n){return Math.exp((12*n+e-S)*Math.log(2)/12)*L}function r(e){return null===e?"":F[e]}e("body {\n  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;\n  font-size: 13px;\n}\napp-layout {\n  display: flex;\n}\napp-layout app-layout-left {\n  flex: 0 0 800px;\n}\napp-layout app-layout-right {\n  flex: 1 0 1px;\n}\nbutton {\n  font-weight: bold;\n  background-color: #444;\n  color: #fff;\n  border: 2px black solid;\n  height: 25px;\n  line-height: 15px;\n}\nbutton.active {\n  background-color: #e9931d;\n  color: #000;\n}\ninput[type=range]::-webkit-slider-runnable-track {\n  -webkit-appearance: none;\n  width: 300px;\n  height: 6px;\n  border-radius: 3px;\n  background-color: #e9931d;\n}\ninput[type=range]::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  border: 1px #000 solid;\n  height: 15px;\n  width: 5px;\n  background: #444;\n}\nmain-panel {\n  display: block;\n  background: #ddd;\n}\n");var a,i=[];e("keyboard {\n  height: 200px;\n  width: 100%;\n  display: flex;\n  position: relative;\n}\nkeyboard clav {\n  position: relative;\n  flex: 1 0 auto;\n  width: 4.67%;\n  margin: 0;\n  padding: 0;\n  background-color: #fff;\n  height: 99%;\n  border-bottom-left-radius: 10px;\n  border-bottom-right-radius: 10px;\n  border: 1px #000 solid;\n  border-right: none;\n}\nkeyboard clav.pressed {\n  background-color: #e9931d;\n}\nkeyboard clav.black {\n  height: 60%;\n  width: 3%;\n  margin-left: -5%;\n  left: 2.5%;\n  z-index: 100;\n  background-color: #444;\n  color: #fff;\n}\nkeyboard clav.black.pressed {\n  background-color: #e9931d;\n}\nkeyboard clav char {\n  display: block;\n  position: absolute;\n  bottom: 10px;\n  width: 100%;\n  text-align: center;\n}\n");var l,u=!0;["keyup","keydown","keypress"].map(function(e){return window.addEventListener(e,function(n){u=!0,l[e][n.key]&&(n.preventDefault(!0),l[e][n.key].map(function(e){return e(n)}))})});var c=function(e){return function(n){var t=n.key,o=n.then;u&&(l={keyup:{},keydown:{},keypress:{}},u=!1),l[e][t]=l[e][t]||[],l[e][t].push(o)}},s=(c("keypress"),c("keyup")),p=c("keydown"),f=["z","s","x","d","c","v","g","b","h","n","j","m","q","2","w","3","e","r","5","t","6","y","7","u","i"],d=["s","d","g","h","j","2","3","5","6","7"],v=function(e){return d.indexOf(e)>-1},m=function(e){var n=f.indexOf(e);return n>-1?n:null},y={state:{pressed:null},actions:{pressed:function(e,n,t){return{pressed:t}}},views:{keyboard:function(e,o,r,a){return n("keyboard",null,f.map(function(r){var i=m(r),l=function(n){r===e.pressed&&(r===e.pressed&&a.onrelease(i),o.pressed(null))},u=function(n){a.char!==e.pressed&&(r!==e.pressed&&a.onattack(i),o.pressed(r))};return n("clav",{onmousedown:u,onmouseup:l,class:t({white:!v(r),black:v(r),pressed:e.pressed===r})},n("char",null,r.toUpperCase()),n(s,{key:r,then:l}),n(p,{key:r,then:u}))}))}}};e("synth-panel {\n  display: flex;\n  padding: 15px;\n  position: relative;\n}\nsynth-panel span.label {\n  display: inline-block;\n  width: 80px;\n}\nsynth-panel .col-1 {\n  width: 1px;\n  flex: 1 0 auto;\n}\nsynth-panel .col-2 {\n  width: 1px;\n  flex: 1 0 auto;\n}\nsynth-panel input[type=range] {\n  -webkit-appearance: none;\n  width: 200px;\n}\nsynth-panel input[type=range]::-webkit-slide-runnable-track {\n  -webkit-appearance: none;\n  height: 6px;\n  border-radius: 3px;\n  background-color: #e9931d;\n}\nsynth-panel input[type=range]::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  border: 1px #000 solid;\n  height: 15px;\n  width: 8px;\n  border-radius: 2px;\n  margin-top: -4px;\n  background: #444;\n}\nvoice-selector {\n  display: block;\n  padding: 15px;\n  text-align: right;\n  border-bottom: 1px #555 solid;\n}\nvoice-selector button {\n  margin-left: 10px;\n}\n");var g=function(e){var t=e.value,o=e.set,r=e.min,a=e.max,i=e.step;return n("input",{type:"range",min:r||0,max:a,step:i||"any",value:t,oninput:function(e){return o(e.currentTarget.value)}})},b={octave:4,oscillatorType:"triangle",ampLevel:.3,sustainLevel:.6,attackTime:.02,decayTime:.04,releaseTime:.4,filterCutoff:7600,filterQ:10},h=function(e){var t=e.initial,o=e.widget,r=e.params,a=e.name;return{state:{value:t},actions:{set:function(e,n,t){return{value:t}}},views:{control:function(e,t,i,l){var u=l.onset,c=Object.assign(r,{value:e.value,set:function(e){t.set(e),u&&u(e)}});return n("p",null,n("label",null,n("span",{class:"label"},a+":"),o(c)))}}}},k=h({name:"Oscillator",initial:b.oscillatorType,widget:function(e){var o=e.options,r=e.value,a=e.set;return n("span",{class:"button-options"},o.map(function(e){return n("button",{class:t({active:r===e}),onclick:function(n){n.preventDefault(!0),a(e)}},[e])}))},params:{options:["sawtooth","square","triangle","sine"]}}),w=h({name:"Cutoff",initial:b.filterCutoff,widget:g,params:{min:60,max:7600}}),T=h({name:"Octave",initial:b.octave,widget:g,params:{min:1,max:6,step:1}}),x=h({name:"Resonance",initial:b.filterQ,widget:g,params:{max:20}}),C=h({name:"Attack Time",initial:b.attackTime,widget:g,params:{max:.2}}),A=h({name:"Decay Time",initial:b.decayTime,widget:g,params:{max:.2}}),L=440,S=69,N={state:{audioContext:null,oscillatorNode:null,filterNode:null,envelopeNode:null,ampNode:null,playing:null},modules:{oscillatorType:k,octave:T,filterCutoff:w,filterQ:x,attackTime:C,releaseTime:h({name:"Release Time",initial:b.releaseTime,widget:g,params:{max:.2}}),decayTime:A,sustainLevel:h({name:"Sustain Level",initial:b.sustainLevel,widget:g,params:{max:1}}),ampLevel:h({name:"Amp Level",initial:b.ampLevel,widget:g,params:{max:1}})},actions:{init:function(e,n,t){var o=t.createOscillator();o.type=e.oscillatorType.value;var r=t.createBiquadFilter();r.type="lowpass",r.frequency.value=e.filterCutoff.value,r.Q.value=e.filterQ.value;var a=t.createGain();a.gain.value=0;var i=t.createGain();return i.gain.value=e.ampLevel.value,o.connect(r),r.connect(a),a.connect(i),i.connect(t.destination),o.start(),{audioContext:t,oscillator:o,filter:r,envelope:a,amplifier:i}},attack:function(e,n,t){if(e.playing!==t){var r=o(t,e.octave.value),a=e.audioContext.currentTime;return e.oscillator.frequency.cancelScheduledValues(a),e.envelope.gain.cancelScheduledValues(a),a+=.01,e.oscillator.frequency.linearRampToValueAtTime(r,a),e.envelope.gain.linearRampToValueAtTime(0,a),a+=+e.attackTime.value,e.envelope.gain.linearRampToValueAtTime(1,a),a+=+e.decayTime.value,e.envelope.gain.linearRampToValueAtTime(+e.sustainLevel.value,a),{playing:t}}},release:function(e,n,t){if(e.playing===t){var o=e.audioContext.currentTime+.01;return e.envelope.gain.cancelScheduledValues(o),o+=e.releaseTime.value,e.envelope.gain.linearRampToValueAtTime(0,o),{playing:null}}},stop:function(e,n){null!==e.playing&&n.release(e.playing)}},views:{onsave:function(e,n){return{oscillatorType:e.oscillatorType.value,octave:e.octave.value,filterCutoff:e.filterCutoff.value,filterQ:e.filterQ.value,attackTime:e.attackTime.value,decayTime:e.decayTime.value,sustainLevel:e.sustainLevel.value,releaseTime:e.releaseTime.value,ampLevel:e.ampLevel.value}},onload:function(e,n,t,o){n.oscillatorType.set(o.oscillatorType),n.octave.set(o.octave),n.filterCutoff.set(o.filterCutoff),n.filterQ.set(o.filterQ),n.attackTime.set(o.attackTime),n.decayTime.set(o.decayTime),n.sustainLevel.set(o.sustainLevel),n.releaseTime.set(o.releaseTime),n.ampLevel.set(o.ampLevel),e.oscillator.type=o.oscillatorType,e.filter.frequency.value=o.filterCutoff,e.filter.Q.value=o.filterQ,e.amplifier.gain.value=o.ampLevel},panel:function(e,t,o){return n("synth-panel",null,n("div",{class:"col-1"},n(o.oscillatorType.control,{onset:function(n){return e.oscillator.type=n}}),n(o.octave.control,null),n(o.filterCutoff.control,{onset:function(n){return e.filter.frequency.value=n}}),n(o.filterQ.control,{onset:function(n){return e.filter.Q.value=n}})),n("div",{class:"col-2"},n(o.attackTime.control,null),n(o.decayTime.control,null),n(o.sustainLevel.control,null),n(o.releaseTime.control,null),n(o.ampLevel.control,{onset:function(n){return e.amplifier.gain.value=n}})))}}},q=function(e,n){for(var t=[],o=0;o<e;o++)t.push(n(o));return t},V=q(8,function(e){return e}),B={modules:{0:N,1:N,2:N,3:N,4:N,5:N,6:N,7:N},state:{selected:0},actions:{select:function(e,n,t){return{selected:t}},init:function(e,n,t){var o=new(window.AudioContext||window.webkitAudioContext);V.forEach(function(e){return n[e].init(o)})}},views:{getSelected:function(e){return e.selected},select:function(e,n,t,o){return n.select(o)},stopAll:function(e,n){return V.map(function(e){return n[e].stop()})},attack:function(e,n,t,o){return n[e.selected].attack(o)},release:function(e,n,t,o){return n[e.selected].release(o)},attackVoice:function(e,n,t,o){var r=o.note;return n[o.voice].attack(r)},releaseVoice:function(e,n,t,o){var r=o.note;return n[o.voice].release(r)},onload:function(e,n,t,o){return V.forEach(function(e){return t[e].onload(o[e])})},onsave:function(e,n,t){return V.map(function(e){return t[e].onsave()})},panel:function(e,n,t){return t[e.selected].panel()},selector:function(e,o,r){return n("voice-selector",null,V.map(function(r){return n("button",{onmousedown:function(e){return o.select(r)},class:t({active:e.selected===r})},"Voice ",r+1)}))}}};e("table.sequencer {\n  border-collapse: collapse;\n}\ntable.sequencer td {\n  border: 1px #ccc solid;\n  width: 50px;\n}\ntable.sequencer td.selected {\n  background: #e9931d;\n}\ntable.sequencer td.time {\n  background: #ccc;\n  text-align: right;\n}\ntable.sequencer td.playing {\n  background: #ddd;\n}\n");var Q,E=!0;["mouseup","mousedown","mousemove"].map(function(e){return window.addEventListener(e,function(n){E=!0,Q[e].map(function(e){return e(n)})})});var O=function(e){return function(n){var t=n.then;E&&(Q={mouseup:[],mousedown:[],mousemove:[]},E=!1),Q[e].push(t)}},R=(O("mousemove"),O("mousedown"),O("mouseup")),D=32,F=["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B","C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B","C"],G={modules:{selection:{state:{start:-1,end:-1,selecting:!1,col:null},actions:{reset:function(e){return{start:-1,end:-1,selecting:!1}},start:function(e,n,t){var o=t.row;return{selecting:!0,start:o,end:o,col:t.col}},set:function(e,n,t){var o=t.row;if(e.selecting)return{end:o}},stop:function(e,n){return{selecting:!1}}},views:{setNote:function(e,n,t,o){var r=o.value,a=o.grid;if(-1!==e.start){for(var i=e.start,l=e.end,u=i<l?[i,l]:[l,i],c=u[1],s=u[0];s<=c;s++)a[s][e.col]=r;return n.reset(),a}},isSelected:function(e,n,t,o){var r=o.row;return o.col===e.col&&(r>=e.start&&r<=e.end||r<=e.start&&r>=e.end)},selectable:function(e,n,o,r,a){var i=r.row,l=r.col,u=r.oncol;return a.map(function(e){return e.props.class=t([e.props.class,{selected:o.isSelected({row:i,col:l})}]),e.props.onmousedown=function(e){e.preventDefault(!0),u(l),n.start({row:i,col:l})},e.props.onmousemove=function(e){e.preventDefault(!0),n.set({row:i})},e})},clearButton:function(e,t,o,r){var a=r.grid;return[n(R,{then:t.stop}),n(p,{key:" ",then:function(e){return o.setNote({note:null,grid:a})}}),n("button",{onmousedown:function(e){return o.setNote({note:null,grid:a})}},"X")]}}},recording:{state:{on:!1,note:null,voice:null},actions:{start:function(e){return{on:!0}},stop:function(e){return{on:!1}},setNote:function(e,n,t){return{note:t.note,voice:t.voice}},attack:function(e,n,t){var o=t.note,r=t.voice;if(e.on&&o!==e.note&&r!==e.voice)return{note:o,voice:r}},release:function(e,n,t){if(t.note===e.note)return{note:null,voice:null}}},views:{attack:function(e,n,t,o){var r=o.note,a=o.voice;return n.setNote({note:r,voice:a})},release:function(e,n,t,o){return n.setNote({note:null,voice:null})},start:function(e,n){return n.start()},stop:function(e,n){return n.stop()},recordButton:function(e,o,r,a){var i=a.onstart;return n("button",{onmousedown:function(e){o.start(),i&&i()},class:t({active:e.on})},"Rec")}}},playback:{state:{on:!1,interval:null,time:0},actions:{start:function(e,n){if(!e.on)return{on:!0,interval:setInterval(n.advance,100)}},stop:function(e,n){if(e.on)return e.interval&&clearInterval(e.interval),{on:!1,interval:null}},advance:function(e,n){return{time:(e.time+1)%D}},setTime:function(e,n,t){return{time:t}}},views:{start:function(e,n){return n.start()},stop:function(e,n){return n.stop()},setTime:function(e,n,t,o){return{time:o}},nowPlaying:function(e,n,t,o){return o===e.time},play:function(e,n,t,o){var r=o.times,a=o.onattack,i=o.onrelease;if(e.on){var l=r[e.time],u=r[(e.time+D-1)%D];l.forEach(function(e,n){e!==u[n]&&(null!==e?a({voice:n,note:e}):i({voice:n,note:u[n]}))})}},startButton:function(e,o,r,a){var i=a.onstart;return n("button",{onmousedown:function(n){e.on||(o.start(),i&&i())},class:t({active:e.on})},"Play")},stopButton:function(e,t,o,r){var a=r.onstop;return n("button",{onmousedown:function(n){e.on&&(t.stop(),a&&a())}},"Stop")}}}},state:{times:q(D,function(e){return q(8,function(e){return null})})},actions:{setTimes:function(e,n,t){if(t)return{times:t}},setRecordedNote:function(e,n){e.recording.on&&null!==e.recording.note&&(e.times[e.playback.time][e.recording.voice]=e.recording.note,n.setTimes(e.times))}},views:{attack:function(e,n,t,o){var r=t.selection,a=t.recording,i=o.note,l=o.voice;n.setTimes(r.setNote({grid:e.times,value:i})),a.attack({note:i,voice:l})},release:function(e,n,t,o){var r=t.recording,a=o.note,i=o.voice;r.release({note:a,voice:i})},onsave:function(e){return e.times},onload:function(e,n,t,o){return n.setTimes(o)},grid:function(e,o,a,i){var l=a.playback,u=a.selection,c=i.onattack,s=i.onrelease,p=i.onselectVoice;return l.play({times:e.times,onattack:c,onrelease:s}),o.setRecordedNote(),n("table",{class:"sequencer"},e.times.map(function(e,o){return n("tr",null,n("td",{class:"time",onclick:function(e){return l.setTime(o)}},o),e.map(function(e,a){return n(u.selectable,{row:o,col:a,oncol:p},n("td",{class:t({playing:l.nowPlaying(o)})},r(e)))}))}))},controls:function(e,t,o,r){var a=o.playback,i=o.recording,l=o.selection,u=r.onstop;return n("span",null,n(i.recordButton,{onstart:a.start}),n(a.startButton,null),n(a.stopButton,{onstop:function(e){i.stop(),u&&u()}}),n(l.clearButton,{grid:e.times}))}}};!function(e){function n(e,n,t,o){return function(r,a){return o(e,n,t,r,a)}}function t(e,o,r){var a={};for(var i in r.modules||{})a[i]=t(e[i],o[i],r.modules[i]);for(var l in r.views||{})a[l]=n(e,o,a,r.views[l]);return a}return function(n,o){var r=n.view;return r&&(n.view=function(e,o){return r(e,o,t(e,o,n))}),e(n,o)}}(function(e,t){function o(){e.view&&!g&&requestAnimationFrame(r,g=!g)}function r(){a(k=y(t,k,w,w=e.view(b,h),g=!g))}function a(e){for(;e=T.pop();)e()}function i(e,t){return e&&n(e.tagName.toLowerCase(),{},t.call(e.childNodes,function(e){return 3===e.nodeType?e.nodeValue:i(e,t)}))}function l(e,n,t){e.init&&T.push(function(){e.init(n,t)}),c(n,e.state),u(n,t,e.actions);for(var o in e.modules)l(e.modules[o],n[o]={},t[o]={})}function u(e,n,t){function r(n){return"function"==typeof n?r(n(e)):n&&o(c(e,n)),e}Object.keys(t||{}).map(function(o){"function"==typeof t[o]?n[o]=function(a){return"function"==typeof(a=t[o](e,n,a))?a(r):r(a)}:u(e[o]||(e[o]={}),n[o]={},t[o])})}function c(e,n){for(var t in n)e[t]=n[t];return e}function s(e,n){return c(c({},e),n)}function p(e,n){if("string"==typeof e)t=document.createTextNode(e);else{var t=(n=n||"svg"===e.type)?document.createElementNS("http://www.w3.org/2000/svg",e.type):document.createElement(e.type);for(e.props&&e.props.oncreate&&T.push(function(){e.props.oncreate(t)}),o=0;o<e.children.length;o++)t.appendChild(p(e.children[o],n));for(var o in e.props)f(t,o,e.props[o])}return t}function f(e,n,t,o){if("key"===n);else if("style"===n)for(var n in s(o,t=t||{}))e.style[n]=t[n]||"";else{try{e[n]=t}catch(e){}"function"!=typeof t&&(t?e.setAttribute(n,t):e.removeAttribute(n))}}function d(e,n,t){for(var o in s(n,t)){var r=t[o],a="value"===o||"checked"===o?e[o]:n[o];r!==a&&r!==a&&f(e,o,r,a)}t&&t.onupdate&&T.push(function(){t.onupdate(e,n)})}function v(e,n,t){function o(){e.removeChild(n)}t&&t.onremove&&"function"==typeof(t=t.onremove(n))?t(o):o()}function m(e){if(e&&e.props)return e.props.key}function y(e,n,t,o,r,a){if(null==t)n=e.insertBefore(p(o,r),n);else if(null!=o.type&&o.type===t.type){d(n,t.props,o.props),r=r||"svg"===o.type;for(var i=o.children.length,l=t.children.length,u={},c=[],s={},f=0;f<l;f++)b=c[f]=n.childNodes[f],null!=(x=m(h=t.children[f]))&&(u[x]=[b,h]);for(var f=0,g=0;g<i;){var b=c[f],h=t.children[f],k=o.children[g];if(s[x=m(h)])f++;else{var w=m(k),T=u[w]||[];null==w?(null==x&&(y(n,b,h,k,r),g++),f++):(x===w?(y(n,T[0],T[1],k,r),f++):T[0]?(n.insertBefore(T[0],b),y(n,T[0],T[1],k,r)):y(n,b,null,k,r),g++,s[w]=k)}}for(;f<l;){var x=m(h=t.children[f]);null==x&&v(n,c[f],h.props),f++}for(var f in u){var C=(T=u[f])[1];s[C.props.key]||v(n,T[0],C.props)}}else n&&o!==n.nodeValue&&("string"==typeof o&&"string"==typeof t?n.nodeValue=o:(n=e.insertBefore(p(o,r),a=n),v(e,a,t.props)));return n}var g,b,h,k=(t=t||document.body).children[0],w=i(k,[].map),T=[];return o(a(l(e,b={},h={}))),h})({modules:{keyboard:y,soundbank:B,sequencer:G},views:{loadState:function(e,n,t){n.soundbank.init();var o=localStorage.getItem("SYNTHDATA");if(o){var r=JSON.parse(o),a=r.voices,i=r.notes;a&&t.soundbank.onload(a),i&&t.sequencer.onload(i)}},saveState:function(e,n,t){localStorage.setItem("SYNTHDATA",JSON.stringify({voices:t.soundbank.onsave(),notes:t.sequencer.onsave()}))}},view:function(e,t,o){var r=o.loadState,a=o.saveState,i=o.keyboard,l=o.soundbank,u=o.sequencer;return n("app-layout",{oncreate:r,onupdate:a},n("app-layout-left",null,n("main-panel",null,n(u.controls,{onstop:l.stopAll}),n(l.selector,null),n(l.panel,null)),n(i.keyboard,{onattack:function(e){l.attack(e),u.attack({note:e,voice:l.getSelected()})},onrelease:function(e){l.release(e),u.release({note:e,voice:l.getSelected()})}})),n("app-layout-right",null,n(u.grid,{selectedVoice:l.getSelected(),onselectVoice:function(e){return l.select(e)},onattack:function(e){var n=e.note,t=e.voice;return l.attackVoice({note:n,voice:t})},onrelease:function(e){var n=e.note,t=e.voice;return l.releaseVoice({note:n,voice:t})}})))}})}();
