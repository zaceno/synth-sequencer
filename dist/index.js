!function(){"use strict";function e(e){if(e||window){var n=document.createElement("style");return n.setAttribute("media","screen"),n.innerHTML=e,document.head.appendChild(n),e}}function n(e,n,t){return Object.keys(e||{}).reduce(function(t,o){return t[o]=n(e[o],o,t),t},t||{})}function t(e,o){for(var r=[],a=arguments.length-2;a-- >0;)r[a]=arguments[a+2];return n(o,function(n,o,a){return"function"==typeof n?e.apply(void 0,[n,a].concat(r)):t.apply(void 0,[e,n].concat(r.map(function(e){return e[o]})))})}function o(e,t){return n(e.sub,function(e){return Object.assign({},o(e,t))},e[t])}function r(e,n){var t,o=arguments,r=[];for(b=arguments.length;b-- >2;)h.push(o[b]);for(;h.length;)if(Array.isArray(t=h.pop()))for(b=t.length;b--;)h.push(t[b]);else null!=t&&!0!==t&&!1!==t&&r.push("number"==typeof t?t+="":t);return"string"==typeof e?{type:e,props:n||{},children:r}:e(n||{},r)}function a(e,n,t,o){for(var r=f(t||(t=document.body),t.children[0],e,n);o=k.pop();)o();return r}function i(e,n){var t={};for(var o in e)t[o]=e[o];for(var o in n)t[o]=n[o];return t}function l(e,n){if("string"==typeof e)t=document.createTextNode(e);else{var t=(n=n||"svg"===e.type)?document.createElementNS("http://www.w3.org/2000/svg",e.type):document.createElement(e.type);e.props&&e.props.oncreate&&k.push(function(){e.props.oncreate(t)});for(o=0;o<e.children.length;o++)t.appendChild(l(e.children[o],n));for(var o in e.props)u(t,o,e.props[o])}return t}function u(e,n,t,o){if("key"===n);else if("style"===n)for(var n in i(o,t=t||{}))e.style[n]=t[n]||"";else{try{e[n]=t}catch(e){}"function"!=typeof t&&(t?e.setAttribute(n,t):e.removeAttribute(n))}}function c(e,n,t){for(var o in i(n,t)){var r=t[o],a="value"===o||"checked"===o?e[o]:n[o];r!==a&&u(e,o,r,a)}t&&t.onupdate&&k.push(function(){t.onupdate(e,n)})}function s(e,n,t){function o(){e.removeChild(n)}t&&t.onremove&&"function"==typeof(t=t.onremove(n))?t(o):o()}function p(e){if(e&&e.props)return e.props.key}function f(e,n,t,o,r,a){if(null==t)n=e.insertBefore(l(o,r),n);else if(null!=o.type&&o.type===t.type){c(n,t.props,o.props),r=r||"svg"===o.type;for(var i=o.children.length,u=t.children.length,d={},v=[],m={},y=0;y<u;y++){b=v[y]=n.childNodes[y];null!=(x=p(h=t.children[y]))&&(d[x]=[b,h])}for(var y=0,g=0;g<i;){var b=v[y],h=t.children[y],k=o.children[g];if(m[x=p(h)])y++;else{var w=p(k),T=d[w]||[];null==w?(null==x&&(f(n,b,h,k,r),g++),y++):(x===w?(f(n,T[0],T[1],k,r),y++):T[0]?(n.insertBefore(T[0],b),f(n,T[0],T[1],k,r)):f(n,b,null,k,r),g++,m[w]=k)}}for(;y<u;){var x=p(h=t.children[y]);null==x&&s(n,v[y],h.props),y++}for(var y in d){var A=(T=d[y])[1];m[A.props.key]||s(n,T[0],A.props)}}else n&&o!==n.nodeValue&&("string"==typeof o&&"string"==typeof t?n.nodeValue=o:(n=e.insertBefore(l(o,r),a=n),s(e,a,t.props)));return n}function d(){T=!0}function v(){L=!0}function m(e,n){var t,o="",r=typeof e;if(e&&"string"===r||"number"===r)return e;if(n=n||" ",Array.isArray(e)&&e.length)for(var a=0,i=e.length;a<i;a++)(t=m(e[a],n))&&(o+=(o&&n)+t);else for(var a in e)e.hasOwnProperty(a)&&(t=e[a])&&(o+=(o&&n)+a+("object"==typeof t?m(t,n+a):""));return o}function y(e,n){return Math.exp((12*n+e-U)*Math.log(2)/12)*Y}function g(e){return null===e?"":ee[e]}e("body {\n  font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;\n  font-size: 13px;\n}\napp-layout {\n  display: flex;\n}\napp-layout app-layout-left {\n  flex: 0 0 800px;\n}\napp-layout app-layout-right {\n  flex: 1 0 1px;\n}\nbutton {\n  font-weight: bold;\n  background-color: #444;\n  color: #fff;\n  border: 2px black solid;\n  height: 25px;\n  line-height: 15px;\n}\nbutton.active {\n  background-color: #e9931d;\n  color: #000;\n}\ninput[type=range]::-webkit-slider-runnable-track {\n  -webkit-appearance: none;\n  width: 300px;\n  height: 6px;\n  border-radius: 3px;\n  background-color: #e9931d;\n}\ninput[type=range]::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  border: 1px #000 solid;\n  height: 15px;\n  width: 5px;\n  background: #444;\n}\nmain-panel {\n  display: block;\n  background: #ddd;\n}\n");var b,h=[],k=[],w={keyup:{},keydown:{},keypress:{}},T=!0;["keyup","keydown","keypress"].map(function(e){return window.addEventListener(e,function(n){n.preventDefault(!0),w[e][n.key]&&w[e][n.key].map(function(e){return e(n)})})});var x=function(e){return function(n){var t=n.key,o=n.then;T&&(w={keyup:{},keydown:{},keypress:{}},T=!1),w[e][t]=w[e][t]||[],w[e][t].push(o)}},A=(x("keypress"),x("keyup")),C=x("keydown"),L=!0,S=[].map(function(e){return window.addEventListener(e,function(n){S[e].map(function(e){return e(n)})})}),V=function(e){return function(n){var t=n.then;L&&(S={mouseup:[],mousedown:[],mousemove:[]},L=!1),S[e].push(t)}},N=(V("mousemove"),V("mousedown"),V("mouseup"));e("keyboard {\n  height: 200px;\n  width: 100%;\n  display: flex;\n  position: relative;\n}\nkeyboard clav {\n  position: relative;\n  flex: 1 0 auto;\n  width: 4.67%;\n  margin: 0;\n  padding: 0;\n  background-color: #fff;\n  height: 99%;\n  border-bottom-left-radius: 10px;\n  border-bottom-right-radius: 10px;\n  border: 1px #000 solid;\n  border-right: none;\n}\nkeyboard clav.pressed {\n  background-color: #e9931d;\n}\nkeyboard clav.black {\n  height: 60%;\n  width: 3%;\n  margin-left: -5%;\n  left: 2.5%;\n  z-index: 100;\n  background-color: #444;\n  color: #fff;\n}\nkeyboard clav.black.pressed {\n  background-color: #e9931d;\n}\nkeyboard clav char {\n  display: block;\n  position: absolute;\n  bottom: 10px;\n  width: 100%;\n  text-align: center;\n}\n");var q=["z","s","x","d","c","v","g","b","h","n","j","m","q","2","w","3","e","r","5","t","6","y","7","u","i"],B=["s","d","g","h","j","2","3","5","6","7"],E=function(e){return B.indexOf(e)>-1},O=function(e){var n=q.indexOf(e);return n>-1?n:null},Q={state:{pressed:null},actions:{pressed:function(e,n,t){return{pressed:t}}},views:{keyboard:function(e,n,t,o){var a=o.onattack,i=o.onrelease;return r("keyboard",null,q.map(function(t){var o=O(t),l=function(r){t===e.pressed&&(t===e.pressed&&i(o),n.pressed(null))},u=function(r){t!==e.pressed&&(t!==e.pressed&&a(o),n.pressed(t))};return r("clav",{onmousedown:u,onmouseup:l,class:m({white:!E(t),black:E(t),pressed:e.pressed===t})},r("char",null,t.toUpperCase()),r(A,{key:t,then:l}),r(C,{key:t,then:u}))}))}}};e("synth-panel {\n  display: flex;\n  padding: 15px;\n  position: relative;\n}\nsynth-panel span.label {\n  display: inline-block;\n  width: 80px;\n}\nsynth-panel .col-1 {\n  width: 1px;\n  flex: 1 0 auto;\n}\nsynth-panel .col-2 {\n  width: 1px;\n  flex: 1 0 auto;\n}\nsynth-panel input[type=range] {\n  -webkit-appearance: none;\n  width: 200px;\n}\nsynth-panel input[type=range]::-webkit-slide-runnable-track {\n  -webkit-appearance: none;\n  height: 6px;\n  border-radius: 3px;\n  background-color: #e9931d;\n}\nsynth-panel input[type=range]::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  border: 1px #000 solid;\n  height: 15px;\n  width: 8px;\n  border-radius: 2px;\n  margin-top: -4px;\n  background: #444;\n}\nvoice-selector {\n  display: block;\n  padding: 15px;\n  text-align: right;\n  border-bottom: 1px #555 solid;\n}\nvoice-selector button {\n  margin-left: 10px;\n}\n");var R=function(e){var n=e.value,t=e.set,o=e.min,a=e.max,i=e.step;return r("input",{type:"range",min:o||0,max:a,step:i||"any",value:n,oninput:function(e){return t(+e.currentTarget.value)}})},D={octave:4,oscillatorType:"triangle",ampLevel:.3,sustainLevel:.6,attackTime:.02,decayTime:.04,releaseTime:.4,filterCutoff:7600,filterQ:10},j=function(e){var n=e.initial,t=e.widget,o=e.params,a=e.name;return{state:{value:n},actions:{set:function(e,n,t){return{value:t}}},views:{control:function(e,n,i,l){var u=l.onset,c=Object.assign(o,{value:e.value,set:function(e){n.set(e),u&&u(e)}});return r("p",null,r("label",null,r("span",{class:"label"},a+":"),t(c)))}}}},G=j({name:"Oscillator",initial:D.oscillatorType,widget:function(e){var n=e.options,t=e.value,o=e.set;return r("span",{class:"button-options"},n.map(function(e){return r("button",{class:m({active:t===e}),onclick:function(n){n.preventDefault(!0),o(e)}},[e])}))},params:{options:["sawtooth","square","triangle","sine"]}}),I=j({name:"Cutoff",initial:D.filterCutoff,widget:R,params:{min:60,max:7600}}),P=j({name:"Octave",initial:D.octave,widget:R,params:{min:1,max:6,step:1}}),F=j({name:"Resonance",initial:D.filterQ,widget:R,params:{max:20}}),M=j({name:"Attack Time",initial:D.attackTime,widget:R,params:{max:.2}}),z=j({name:"Decay Time",initial:D.decayTime,widget:R,params:{max:.2}}),W=j({name:"Release Time",initial:D.releaseTime,widget:R,params:{max:.8}}),H=j({name:"Sustain Level",initial:D.sustainLevel,widget:R,params:{max:1}}),J=j({name:"Amp Level",initial:D.ampLevel,widget:R,params:{max:1}}),Y=440,U=69,X={state:{audioContext:null,oscillatorNode:null,filterNode:null,envelopeNode:null,ampNode:null,playing:null},sub:Object.freeze({oscillatorType:G,filterCutoff:I,octave:P,filterQ:F,attackTime:M,decayTime:z,releaseTime:W,sustainLevel:H,ampLevel:J}),actions:{init:function(e,n,t){var o=t.createOscillator();o.type=e.oscillatorType.value;var r=t.createBiquadFilter();r.type="lowpass",r.frequency.value=e.filterCutoff.value,r.Q.value=e.filterQ.value;var a=t.createGain();a.gain.value=0;var i=t.createGain();return i.gain.value=e.ampLevel.value,o.connect(r),r.connect(a),a.connect(i),i.connect(t.destination),o.start(),{audioContext:t,oscillator:o,filter:r,envelope:a,amplifier:i}},setNote:function(e,n,t){return{playing:t}}},views:{attack:function(e,n,t,o){if(e.playing!==o){n.setNote(o);var r=y(o,e.octave.value),a=e.audioContext.currentTime;e.oscillator.frequency.cancelScheduledValues(a),e.envelope.gain.cancelScheduledValues(a),a+=.01,e.oscillator.frequency.linearRampToValueAtTime(r,a),e.envelope.gain.linearRampToValueAtTime(0,a),a+=+e.attackTime.value,e.envelope.gain.linearRampToValueAtTime(1,a),a+=+e.decayTime.value,e.envelope.gain.linearRampToValueAtTime(+e.sustainLevel.value,a)}},release:function(e,n,t,o){if(e.playing===o){n.setNote(null);var r=e.audioContext.currentTime+.01;e.envelope.gain.cancelScheduledValues(r),r+=+e.releaseTime.value,e.envelope.gain.linearRampToValueAtTime(0,r)}},stop:function(e,n,t){var o=t.release;null!==e.playing&&o(e.playing)},onsave:function(e){return{oscillatorType:e.oscillatorType.value,octave:e.octave.value,filterCutoff:e.filterCutoff.value,filterQ:e.filterQ.value,attackTime:e.attackTime.value,decayTime:e.decayTime.value,sustainLevel:e.sustainLevel.value,releaseTime:e.releaseTime.value,ampLevel:e.ampLevel.value}},onload:function(e,n,t,o){n.oscillatorType.set(o.oscillatorType),n.octave.set(o.octave),n.filterCutoff.set(o.filterCutoff),n.filterQ.set(o.filterQ),n.attackTime.set(o.attackTime),n.decayTime.set(o.decayTime),n.sustainLevel.set(o.sustainLevel),n.releaseTime.set(o.releaseTime),n.ampLevel.set(o.ampLevel),e.oscillator.type=o.oscillatorType,e.filter.frequency.value=o.filterCutoff,e.filter.Q.value=o.filterQ,e.amplifier.gain.value=o.ampLevel},panel:function(e,n,t){return r("synth-panel",null,r("div",{class:"col-1"},r(t.oscillatorType.control,{onset:function(n){return e.oscillator.type=n}}),r(t.octave.control,null),r(t.filterCutoff.control,{onset:function(n){return e.filter.frequency.value=n}}),r(t.filterQ.control,{onset:function(n){return e.filter.Q.value=n}})),r("div",{class:"col-2"},r(t.attackTime.control,null),r(t.decayTime.control,null),r(t.sustainLevel.control,null),r(t.releaseTime.control,null),r(t.ampLevel.control,{onset:function(n){return e.amplifier.gain.value=n}})))}}},K=function(e,n){for(var t=[],o=0;o<e;o++)t.push(n(o));return t},Z=K(8,function(e){return e}),$={sub:{0:X,1:X,2:X,3:X,4:X,5:X,6:X,7:X},state:{selected:0},actions:{select:function(e,n,t){return{selected:t}},init:function(e,n){var t=new(window.AudioContext||window.webkitAudioContext);Z.forEach(function(e){return n[e].init(t)})}},views:{getSelected:function(e){return e.selected},select:function(e,n,t,o){return n.select(o)},stopAll:function(e,n,t){return Z.map(function(e){return t[e].stop()})},attack:function(e,n,t,o){return t[e.selected].attack(o)},release:function(e,n,t,o){return t[e.selected].release(o)},attackVoice:function(e,n,t,o){var r=o.note;return t[o.voice].attack(r)},releaseVoice:function(e,n,t,o){var r=o.note;return t[o.voice].release(r)},onload:function(e,n,t,o){return Z.forEach(function(e){return t[e].onload(o[e])})},onsave:function(e,n,t){return Z.map(function(e){return t[e].onsave()})},panel:function(e,n,t){return t[e.selected].panel()},selector:function(e,n,t){return r("voice-selector",null,Z.map(function(t){return r("button",{onmousedown:function(e){return n.select(t)},class:m({active:e.selected===t})},"Voice ",t+1)}))}}};e("table.sequencer {\n  border-collapse: collapse;\n}\ntable.sequencer td {\n  border: 1px #ccc solid;\n  width: 50px;\n}\ntable.sequencer td.selected {\n  background: #e9931d;\n}\ntable.sequencer td.time {\n  background: #ccc;\n  text-align: right;\n}\ntable.sequencer td.playing {\n  background: #ddd;\n}\n");var _=32,ee=["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B","C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B","C"],ne=function(e,n){var r,a=function(e){r||(r=!r,setTimeout(function(e){r=!r,n&&n()},0))},i=o(e,"state"),l=t(function(e,n,t){return function(){for(var o=[],r=arguments.length;r--;)o[r]=arguments[r];var i=e.apply(void 0,[t,n].concat(o));i&&(Object.assign(t,i),a())}},o(e,"actions"),i),u=t(function(e,n,t,o){return function(){for(var r=[],a=arguments.length;a--;)r[a]=arguments[a];return e.apply(void 0,[t,o,n].concat(r))}},o(e,"views"),i,l);return a(),{actions:l,views:u}}({sub:{keyboard:Q,soundbank:$,sequencer:{sub:{selection:{state:{start:-1,end:-1,selecting:!1,on:!1,col:null},actions:{reset:function(e){return{on:!1,start:-1,end:-1,selecting:!1}},start:function(e,n,t){var o=t.row;return{on:!0,selecting:!0,start:o,end:o,col:t.col}},set:function(e,n,t){var o=t.row;if(e.selecting)return{end:o}},stop:function(e){return{selecting:!1}}},views:{map:function(e,n,t,o){var r=o.value,a=o.grid;if(e.on){for(var i=e.start,l=e.end,u=i<l?[i,l]:[l,i],c=u[1],s=u[0];s<=c;s++)a[s][e.col]=r;return n.reset(),a}},isSelected:function(e,n,t,o){var r=o.row;return o.col===e.col&&(r>=e.start&&r<=e.end||r<=e.start&&r>=e.end)},selectable:function(e,n,t,o,r){var a=t.isSelected,i=o.row,l=o.col,u=o.oncol;return r.map(function(e){return e.props.class=m([e.props.class,{selected:a({row:i,col:l})}]),e.props.onmousedown=function(e){e.preventDefault(!0),u(l),n.start({row:i,col:l})},e.props.onmousemove=function(e){e.preventDefault(!0),n.set({row:i})},e})}}},recording:{state:{on:!1,note:null,voice:null},actions:{start:function(e){return{on:!0}},stop:function(e){return{on:!1}},setNote:function(e,n,t){return{note:t.note,voice:t.voice}}},views:{getVoice:function(e){return e.on?e.voice:null},attack:function(e,n,t,o){var r=o.note,a=o.voice;if(e.on&&r!==e.note&&(console.log("ATTACING",r,e.note,a,e.voice),a!==e.voice))return n.setNote({note:r,voice:a})},release:function(e,n,t,o){var r=o.note;if(r===e.note)return console.log("RELEASING",r),n.setNote({note:null,voice:null})},start:function(e,n){return n.start()},stop:function(e,n){return n.stop()},recordButton:function(e,n,t,o){var a=o.onstart;return r("button",{onmousedown:function(e){n.start(),a&&a()},class:m({active:e.on})},"Rec")}}},playback:{state:{on:!1,interval:null,time:0,played:null},actions:{start:function(e,n){if(!e.on)return{on:!0,interval:setInterval(n.advance,100)}},stop:function(e,n){if(e.on)return e.interval&&clearInterval(e.interval),{on:!1,interval:null}},advance:function(e,n){return{time:(e.time+1)%_}},setTime:function(e,n,t){return{time:t}},setPlayed:function(e){return{played:e.time}}},views:{start:function(e,n){return n.start()},stop:function(e,n){return n.stop()},setTime:function(e,n,t,o){return n.setTime(o)},nowPlaying:function(e,n,t,o){return o===e.time},play:function(e,n,t,o){var r=o.times,a=o.onattack,i=o.onrelease,l=o.recordingVoice;if(e.on&&e.played!==e.time){n.setPlayed();var u=r[e.time],c=r[(e.time+_-1)%_];u.forEach(function(e,n){n!==l&&e!==c[n]&&(null!==e?a({voice:n,note:e}):i({voice:n,note:c[n]}))})}},startButton:function(e,n,t,o){var a=o.onstart;return r("button",{onmousedown:function(t){e.on||(n.start(),a&&a())},class:m({active:e.on})},"Play")},stopButton:function(e,n,t,o){var a=o.onstop;return r("button",{onmousedown:function(t){e.on&&(n.stop(),a&&a())}},"Stop")}}}},state:{times:K(_,function(e){return K(8,function(e){return null})})},actions:{setTimes:function(e,n,t){return{times:t}},setTimesWith:function(e,n,t){var o=t.note,r=t.map;return n.setTimes(r({value:o,grid:e.times}))},setRecordedNote:function(e,n){e.recording.on&&null!==e.recording.note&&(e.times[e.playback.time][e.recording.voice]=e.recording.note,n.setTimes(e.times))}},views:{attack:function(e,n,t,o){var r=t.selection,a=t.recording,i=o.note,l=o.voice;e.selection.on&&n.setTimesWith({note:i,map:r.map}),a.attack({note:i,voice:l})},release:function(e,n,t,o){var r=t.recording,a=o.note,i=o.voice;r.release({note:a,voice:i})},onsave:function(e){return e.times},onload:function(e,n,t,o){return n.setTimes(o)},grid:function(e,n,t,o){var a=t.playback,i=t.selection,l=t.recording,u=o.onattack,c=o.onrelease,s=o.onselectVoice;return r("table",{class:"sequencer",onupdate:function(t){a.play({times:e.times,onattack:u,onrelease:c,recordingVoice:l.getVoice()}),n.setRecordedNote()}},e.times.map(function(e,n){return r("tr",null,r("td",{class:"time",onclick:function(e){return a.setTime(n)}},n),e.map(function(e,t){return r(i.selectable,{row:n,col:t,oncol:s},r("td",{class:m({playing:a.nowPlaying(n)})},g(e)))}))}))},controls:function(e,n,t,o){var a=t.playback,i=t.recording,l=t.selection,u=o.onstop;return r("span",null,r(N,{then:n.selection.stop}),r(C,{key:" ",then:function(e){n.setTimesWith({note:null,map:l.map})}}),r(i.recordButton,{onstart:a.start}),r(a.startButton,null),r(a.stopButton,{onstop:function(e){i.stop(),u&&u()}}),r("button",{onmousedown:function(e){n.setTimesWith({note:null,map:l.map})}},"X"))}}}},views:{loadState:function(e,n,t){var o=localStorage.getItem("SYNTHDATA");if(o){var r=JSON.parse(o),a=r.voices,i=r.notes;a&&t.soundbank.onload(a),i&&t.sequencer.onload(i)}},saveState:function(e,n,t){localStorage.setItem("SYNTHDATA",JSON.stringify({voices:t.soundbank.onsave(),notes:t.sequencer.onsave()}))},main:function(e,n,t){var o=t.keyboard,a=t.soundbank,i=t.sequencer;return r("app-layout",null,r("app-layout-left",null,r("main-panel",null,r(i.controls,{onstop:a.stopAll}),r(a.selector,null),r(a.panel,null)),r(o.keyboard,{onattack:function(e){a.attack(e),i.attack({note:e,voice:a.getSelected()})},onrelease:function(e){a.release(e),i.release({note:e,voice:a.getSelected()})}})),r("app-layout-right",null,r(i.grid,{selectedVoice:a.getSelected(),onselectVoice:function(e){return a.select(e)},onattack:function(e){var n=e.note,t=e.voice;return a.attackVoice({note:n,voice:t})},onrelease:function(e){var n=e.note,t=e.voice;return a.releaseVoice({note:n,voice:t})}})))}}},function(e){var n;return function(e){d(),v(),a(n,n=oe.main())}}()),te=ne.actions,oe=ne.views;te.soundbank.init(),oe.loadState()}();
